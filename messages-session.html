<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Managing conversation history and session summarization in Sentinel AI">
      
      
      
        <link rel="canonical" href="https://phonepe.github.io/sentinel-ai/messages-session.html">
      
      
        <link rel="prev" href="tools.html">
      
      
        <link rel="next" href="using-mcp-servers.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Chat Messages and Session Management - Sentinel AI Agent Framework</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
        <script src="assets/external/unpkg.com/iframe-worker/shim.js"></script>
      
    
    
      
        
        
        
        <link rel="stylesheet" href="assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chat-messages-and-session-management" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Sentinel AI Agent Framework" class="md-header__button md-logo" aria-label="Sentinel AI Agent Framework" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sentinel AI Agent Framework
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chat Messages and Session Management
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to system preference" type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/PhonePe/sentinel-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Sentinel AI Agent Framework" class="md-nav__button md-logo" aria-label="Sentinel AI Agent Framework" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Sentinel AI Agent Framework
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PhonePe/sentinel-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="agents.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agents
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="tools.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using Tools in Agents
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Chat Messages and Session Management
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="messages-session.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Chat Messages and Session Management
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Features
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tools
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#session-storage-implementations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Session Storage Implementations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Session Storage Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystem-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Filesystem Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elasticsearch-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Elasticsearch Storage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automatic-summarization-compaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Automatic Summarization (Compaction)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Automatic Summarization (Compaction)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-attributes-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model Attributes Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compaction-prompts-customization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compaction Prompts Customization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-summary-schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        Default Summary Schema
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#behaviour" class="md-nav__link">
    <span class="md-ellipsis">
      
        Behaviour
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Behaviour">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conversation-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conversation History
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#facts-injection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Facts Injection
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#warnings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Warnings
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caution-footguns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Caution: Footguns
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="using-mcp-servers.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using MCP Servers
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="calling-remote-services.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Calling Remote HTTP Services
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="agent-registry.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configured Agents and Registry
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="agent-memory.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent Memory
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="observability.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Observability &amp; Events
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="errors.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Handling &amp; Error Types
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Features
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tools
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#session-storage-implementations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Session Storage Implementations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Session Storage Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystem-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Filesystem Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elasticsearch-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Elasticsearch Storage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automatic-summarization-compaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Automatic Summarization (Compaction)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Automatic Summarization (Compaction)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-attributes-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model Attributes Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compaction-prompts-customization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compaction Prompts Customization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-summary-schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        Default Summary Schema
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#behaviour" class="md-nav__link">
    <span class="md-ellipsis">
      
        Behaviour
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Behaviour">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conversation-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conversation History
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#facts-injection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Facts Injection
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#warnings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Warnings
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caution-footguns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Caution: Footguns
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chat-messages-and-session-management">Chat Messages and Session Management<a class="headerlink" href="#chat-messages-and-session-management" title="Permanent link">¶</a></h1>
<p>The <code>AgentSessionExtension</code> provides automated conversation history management and session summarization for Sentinel AI agents. It ensures that agents maintain context across multiple turns by persisting messages and injecting relevant history and summaries into subsequent interactions.</p>
<h2 id="features">Features<a class="headerlink" href="#features" title="Permanent link">¶</a></h2>
<ul>
<li><strong>Automated Message Persistence</strong>: Saves all user and agent messages to a configured storage backend.</li>
<li><strong>Conversation Summarization</strong>: Automatically generates and updates session summaries based on token usage thresholds.</li>
<li><strong>Context Injection</strong>: Injects the latest session summary as a fact in the system prompt.</li>
<li><strong>History Retrieval</strong>: Automatically retrieves and injects previous messages from the session history into the model context.</li>
<li><strong>Pre-filtering</strong>: Supports filtering messages before persistence (e.g., removing system prompts or failed tool calls).</li>
<li><strong>Message Selection</strong>: Supports selecting specific messages for context (e.g., removing unpaired tool calls).</li>
</ul>
<h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">¶</a></h2>
<p>Unlike the Memory or Registry extensions, the <code>AgentSessionExtension</code> <strong>does not expose any tools</strong> to the agent. It operates strictly through automated background processes:
1.  <strong>Fact Injection</strong>: Injects the current session summary into the system prompt.
2.  <strong>History Injection</strong>: Prepends historical messages to the message list before calling the model.
3.  <strong>Post-Processing</strong>: Captures new messages and triggers summarization after the agent execution finishes.</p>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">¶</a></h2>
<p>The extension is configured using the <code>AgentSessionExtensionSetup</code> class.</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>historicalMessageFetchSize</code></td>
<td><code>int</code></td>
<td>30</td>
<td>Number of historical messages to fetch in a single batch.</td>
</tr>
<tr>
<td><code>maxSummaryLength</code></td>
<td><code>int</code></td>
<td>1000</td>
<td>Maximum character length for the generated session summary.</td>
</tr>
<tr>
<td><code>autoSummarizationThresholdPercentage</code></td>
<td><code>int</code></td>
<td>60</td>
<td>Percentage of the model's context window usage that triggers automatic summarization. Set to 0 to summarize every run.</td>
</tr>
<tr>
<td><code>compactionPrompts</code></td>
<td><code>CompactionPrompts</code></td>
<td>DEFAULT</td>
<td>Custom prompts used for the summarization process.</td>
</tr>
</tbody>
</table>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">¶</a></h2>
<p>To use the session extension, add it to your agent's extension list during initialization.</p>
<div class="highlight"><pre><span></span><code><span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">sessionExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AgentSessionExtension</span><span class="p">.</span><span class="o">&lt;</span><span class="n">MyRequest</span><span class="p">,</span><span class="w"> </span><span class="n">MyResponse</span><span class="p">,</span><span class="w"> </span><span class="n">MyAgent</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">sessionStore</span><span class="p">(</span><span class="n">sessionStore</span><span class="p">)</span><span class="w"> </span><span class="c1">// Implementation of SessionStore</span>
<span class="w">        </span><span class="p">.</span><span class="na">mapper</span><span class="p">(</span><span class="n">objectMapper</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">setup</span><span class="p">(</span><span class="n">AgentSessionExtensionSetup</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">autoSummarizationThresholdPercentage</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyAgent</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">sessionExtension</span><span class="p">),</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">());</span>
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">Session ID Requirement</p>
<p>The session extension relies on a <code>sessionId</code> being present in the <code>AgentRequestMetadata</code>. If no <code>sessionId</code> is provided during execution, the extension will skip history persistence and retrieval.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agent</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">AgentInput</span><span class="p">.</span><span class="o">&lt;</span><span class="n">MyRequest</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyRequest</span><span class="p">(...))</span>
<span class="w">        </span><span class="p">.</span><span class="na">requestMetadata</span><span class="p">(</span><span class="n">AgentRequestMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">sessionId</span><span class="p">(</span><span class="s">"session-123"</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="s">"user-456"</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
</code></pre></div>
<h2 id="session-storage-implementations">Session Storage Implementations<a class="headerlink" href="#session-storage-implementations" title="Permanent link">¶</a></h2>
<p>Sentinel AI provides multiple implementations for the <code>SessionStore</code> interface.</p>
<h3 id="filesystem-storage">Filesystem Storage<a class="headerlink" href="#filesystem-storage" title="Permanent link">¶</a></h3>
<p>The <code>FileSystemSessionStore</code> stores session data and messages as JSON files on the local disk. This is suitable for development or single-node deployments.</p>
<p><strong>Dependency:</strong>
</p><div class="highlight"><pre><span></span><code><span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>com.phonepe.sentinel-ai<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>sentinel-ai-filesystem<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><p></p>
<p><strong>Implementation:</strong>
</p><div class="highlight"><pre><span></span><code><span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">sessionStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileSystemSessionStore</span><span class="p">(</span><span class="s">"/path/to/storage"</span><span class="p">,</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">);</span>
</code></pre></div><p></p>
<h3 id="elasticsearch-storage">Elasticsearch Storage<a class="headerlink" href="#elasticsearch-storage" title="Permanent link">¶</a></h3>
<p>The <code>ESSessionStore</code> provides a scalable implementation using Elasticsearch. It supports efficient searching and pagination of sessions and messages.</p>
<p><strong>Dependency:</strong>
</p><div class="highlight"><pre><span></span><code><span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>com.phonepe.sentinel-ai<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>sentinel-ai-storage-es<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><p></p>
<p><strong>Implementation:</strong>
</p><div class="highlight"><pre><span></span><code><span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">esClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESClient</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">serverUrl</span><span class="p">(</span><span class="s">"http://localhost:9200"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">apiKey</span><span class="p">(</span><span class="s">"optional-api-key"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">sessionStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESSessionStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">client</span><span class="p">(</span><span class="n">esClient</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">mapper</span><span class="p">(</span><span class="n">objectMapper</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">indexPrefix</span><span class="p">(</span><span class="s">"my-application"</span><span class="p">)</span><span class="w"> </span><span class="c1">// Optional prefix for indices</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div><p></p>
<h2 id="automatic-summarization-compaction">Automatic Summarization (Compaction)<a class="headerlink" href="#automatic-summarization-compaction" title="Permanent link">¶</a></h2>
<p>One of the most powerful features of the session extension is its ability to automatically "compact" conversation history when it grows too large.</p>
<h3 id="how-it-works">How it Works<a class="headerlink" href="#how-it-works" title="Permanent link">¶</a></h3>
<ol>
<li><strong>Token Estimation</strong>: After each agent run, the extension estimates the number of tokens in the current session history using the model's <code>estimateTokenCount</code> method.</li>
<li><strong>Threshold Evaluation</strong>: It compares the estimated token count against the model's <code>contextWindowSize</code> (configured in <code>ModelSettings</code>).</li>
<li><strong>Trigger</strong>: If <code>(estimatedTokens / contextWindowSize) * 100 &gt; autoSummarizationThresholdPercentage</code>, the extension triggers a summarization task.</li>
<li><strong>Processing</strong>: The summarization task runs asynchronously using the <code>MessageCompactor</code>.</li>
</ol>
<h3 id="model-attributes-configuration">Model Attributes Configuration<a class="headerlink" href="#model-attributes-configuration" title="Permanent link">¶</a></h3>
<p>To ensure accurate threshold evaluation, you should configure the <code>ModelAttributes</code> within your <code>ModelSettings</code>. This tells Sentinel AI about the specific limits and encoding of the model you are using.</p>
<div class="highlight"><pre><span></span><code><span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">modelSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ModelSettings</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">modelAttributes</span><span class="p">(</span><span class="n">ModelAttributes</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">contextWindowSize</span><span class="p">(</span><span class="mi">128_000</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="w">                </span><span class="p">.</span><span class="na">encodingType</span><span class="p">(</span><span class="n">EncodingType</span><span class="p">.</span><span class="na">CL100K_BASE</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)!</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">temperature</span><span class="p">(</span><span class="mf">0.7f</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div>
<ol>
<li><strong>Context Window Size</strong>: The total number of tokens the model can handle (e.g., 128k for GPT-4o).</li>
<li><strong>Encoding Type</strong>: The tokenizer used for counting (e.g., <code>CL100K_BASE</code> for OpenAI models, <code>O200K_BASE</code> for GPT-4o).</li>
</ol>
<h3 id="compaction-prompts-customization">Compaction Prompts Customization<a class="headerlink" href="#compaction-prompts-customization" title="Permanent link">¶</a></h3>
<p>You can customize how the summarization is performed by providing a <code>CompactionPrompts</code> object in the setup.</p>
<div class="highlight"><pre><span></span><code><span class="kd">final</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">customPrompts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompactionPrompts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">summarizationSystemPrompt</span><span class="p">(</span><span class="s">"You are a expert at distilling chat history..."</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">summarizationUserPrompt</span><span class="p">(</span><span class="s">"Please summarize these messages: ${sessionMessages}"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">promptSchema</span><span class="p">(</span><span class="n">myJsonSchema</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div>
<ol>
<li>You can provide a custom JSON schema to change the structure of the generated summary.</li>
</ol>
<h3 id="default-summary-schema">Default Summary Schema<a class="headerlink" href="#default-summary-schema" title="Permanent link">¶</a></h3>
<p>By default, the compactor generates a structured output based on the following JSON schema:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="w">    </span><span class="nt">"keywords"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (2)!</span>
<span class="w">      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">"summary"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// (3)!</span>
<span class="w">    </span><span class="nt">"key_points"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (4)!</span>
<span class="w">      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">"key_facts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (5)!</span>
<span class="w">      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">"sentiment"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (6)!</span>
<span class="w">      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"positive"</span><span class="p">,</span><span class="w"> </span><span class="s2">"neutral"</span><span class="p">,</span><span class="w"> </span><span class="s2">"negative"</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">"confidence"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"number"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// (7)!</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"keywords"</span><span class="p">,</span><span class="w"> </span><span class="s2">"summary"</span><span class="p">,</span><span class="w"> </span><span class="s2">"key_points"</span><span class="p">,</span><span class="w"> </span><span class="s2">"key_facts"</span><span class="p">,</span><span class="w"> </span><span class="s2">"sentiment"</span><span class="p">,</span><span class="w"> </span><span class="s2">"confidence"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li><strong>Title</strong>: A human-readable heading capturing the essence of the conversation.</li>
<li><strong>Keywords</strong>: Relevant topics (1-3 tags).</li>
<li><strong>Summary</strong>: Concise narrative capturing context and outcomes.</li>
<li><strong>Key Points</strong>: Distilled takeaways ordered by importance.</li>
<li><strong>Key Facts</strong>: Objective, verifiable facts extracted from the source.</li>
<li><strong>Sentiment</strong>: Overall tone of the content.</li>
<li><strong>Confidence</strong>: Model-assessed confidence in the summary (0-10).</li>
</ol>
<h2 id="behaviour">Behaviour<a class="headerlink" href="#behaviour" title="Permanent link">¶</a></h2>
<h3 id="conversation-history">Conversation History<a class="headerlink" href="#conversation-history" title="Permanent link">¶</a></h3>
<p>When an agent execution starts, the extension fetches historical messages from the <code>SessionStore</code>. It uses <code>MessageSelector</code> implementations (like <code>UnpairedToolCallsRemover</code>) to ensure the retrieved history is clean and coherent for the LLM.</p>
<h3 id="facts-injection">Facts Injection<a class="headerlink" href="#facts-injection" title="Permanent link">¶</a></h3>
<p>The latest summary is injected into the system prompt as a fact:
</p><div class="highlight"><pre><span></span><code><span class="nt">&lt;knowledge&gt;</span>
<span class="w">    </span><span class="nt">&lt;facts&gt;</span>
<span class="w">        </span><span class="nt">&lt;description&gt;</span>Information<span class="w"> </span>about<span class="w"> </span>session<span class="w"> </span>session-123<span class="nt">&lt;/description&gt;</span>
<span class="w">        </span><span class="nt">&lt;fact&gt;</span>
<span class="w">            </span><span class="nt">&lt;name&gt;</span>A<span class="w"> </span>summary<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>conversation<span class="w"> </span>in<span class="w"> </span>this<span class="w"> </span>session<span class="nt">&lt;/name&gt;</span>
<span class="w">            </span><span class="nt">&lt;content&gt;</span>The<span class="w"> </span>user<span class="w"> </span>asked<span class="w"> </span>about<span class="w"> </span>book<span class="w"> </span>summaries<span class="w"> </span>and<span class="w"> </span>the<span class="w"> </span>agent<span class="w"> </span>provided<span class="w"> </span>details<span class="w"> </span>for<span class="w"> </span>War<span class="w"> </span>and<span class="w"> </span>Peace.<span class="nt">&lt;/content&gt;</span>
<span class="w">        </span><span class="nt">&lt;/fact&gt;</span>
<span class="w">    </span><span class="nt">&lt;/facts&gt;</span>
<span class="nt">&lt;/knowledge&gt;</span>
</code></pre></div><p></p>
<h2 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">¶</a></h2>
<ul>
<li>Summarization happens asynchronously after the main agent execution is completed to avoid increasing latency for the user.</li>
<li>The extension automatically handles "compaction" when the model returns a <code>LENGTH_EXCEEDED</code> error, ensuring the next run has a summarized context.</li>
</ul>
<h2 id="warnings">Warnings<a class="headerlink" href="#warnings" title="Permanent link">¶</a></h2>
<ul>
<li><strong>Concurrent Access</strong>: While storage implementations like <code>ESSessionStore</code> are thread-safe, concurrent updates to the same session summary might lead to race conditions where one summary overwrites another.</li>
<li><strong>Storage Growth</strong>: Without a cleanup policy, session and message indices can grow significantly. Ensure you have a data retention strategy in place.</li>
</ul>
<h2 id="caution-footguns">Caution: Footguns<a class="headerlink" href="#caution-footguns" title="Permanent link">¶</a></h2>
<div class="admonition failure">
<p class="admonition-title">Manual Message Management</p>
<p>Avoid passing <code>oldMessages</code> in <code>AgentInput</code> while using the <code>AgentSessionExtension</code>. The extension automatically retrieves history from the store. Providing <code>oldMessages</code> manually can result in duplicate messages or incorrect message ordering in the model prompt, as <code>oldMessages</code> are injected <em>before</em> the system prompt and extension-managed history.</p>
</div>
<div class="admonition failure">
<p class="admonition-title">Changing Model Context Windows</p>
<p>If you change the model used by an agent to one with a significantly smaller context window, existing sessions might fail with <code>LENGTH_EXCEEDED</code> before the automatic summarization can catch up. Monitor your token usage closely when switching models.</p>
</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2025  PhonePe Private Limited
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.tracking", "navigation.path", "navigation.sections", "content.code.copy", "content.code.annotate", "navigation.expand", "toc.follow", "navigation.top", "search.suggest", "search.highlight", "search.share"], "search": "assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  
<script id="init-glightbox">document.querySelectorAll('.glightbox').forEach(function(element) {
    try {
        var img = element.querySelector('img');
        if (img && img.src) {
            element.setAttribute('href', img.src);
        } else {
            console.log('No img element with src attribute found');
        }
    } catch (error) {
        console.log('Error:', error);
    }
});
const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>